var push_pull=push_pull||{};push_pull.Histogram=function(canvas,table){this._canvas=canvas;this._table=table;this._context=canvas[0].getContext("2d");this._selected=-1;this._bins=[{text:"10 mins",time:1e3*60*10,count:0,colour:"Lime"},{text:"1 hour",time:1e3*60*60,count:0,colour:"LimeGreen"},{text:"2 hours",time:1e3*60*60*2,count:0,colour:"Green"},{text:"5 hours",time:1e3*60*60*5,count:0,colour:"YellowGreen"},{text:"1 day",time:1e3*60*60*24,count:0,colour:"Yellow"},{text:"1 week",time:1e3*60*60*24*7,count:0,colour:"Orange"},{text:"1 month",time:1e3*60*60*24*7*4,count:0,colour:"OrangeRed"},{text:"3 months",time:1e3*60*60*24*7*12,count:0,colour:"Red"},{text:"1 year",time:1e3*60*60*24*7*52,count:0,colour:"Maroon"}];this._axis_size=20;this._height=this._context.canvas.height-this._axis_size;this._width=this._context.canvas.width-this._axis_size;this._bin_width=Math.floor(this._width/this._bins.length);this._canvas.on("mousemove",function(event){this.mouse_move(event)}.bind(this));this._canvas.on("mouseleave",function(){this._selected=-1;this.draw()}.bind(this));this._canvas.on("mouseup",function(event){this.mouse_click(event)}.bind(this));this.mouse_move=function(event){this.pick(event)};this.mouse_click=function(event){this.pick(event);if(this._selected!=-1){var lower_time=0;if(this._selected>0)lower_time=this._bins[this._selected-1].time;push_pull.change_selection(push_pull.STypes.Lifespan,lower_time,this._bins[this._selected].time)}};this.pick=function(event){var x=(event.pageX-this._canvas.offset().left)/this._canvas.width()*this._context.canvas.width;var y=(event.pageY-this._canvas.offset().top)/this._canvas.height()*this._context.canvas.height;if(y>this._height||x<this._axis_size){this._selected=-1;return}else this._selected=Math.floor((x-this._axis_size)/this._bin_width);this.draw()};this.update=function(data){for(var ibin=0;ibin<this._bins.length;ibin++)this._bins[ibin].count=0;for(var idata=0;idata<data.length;idata++){var lifespan=data[idata];for(ibin=0;ibin<this._bins.length;ibin++){if(lifespan<this._bins[ibin].time){this._bins[ibin].count++;break}}}this._max=0;for(ibin=0;ibin<this._bins.length;ibin++)this._max=Math.max(this._max,this._bins[ibin].count);this._table.empty();var select_generator=function(value,value2){return function(event){push_pull.change_selection(push_pull.STypes.Lifespan,value,value2)}};for(ibin=0;ibin<this._bins.length;ibin++){var lower_time=0;if(ibin>0)lower_time=this._bins[ibin-1].time;var row=$('<tr style="cursor:pointer;"><td>'+this._bins[ibin].text+"</td><td>"+this._bins[ibin].count+"</td></tr>");row.on("click",select_generator(lower_time,this._bins[ibin].time));this._table.append(row)}this.draw()};this.draw=function(){this._context.save();this._context.clearRect(0,0,this._context.canvas.width,this._context.canvas.height);for(var ibin=0;ibin<this._bins.length;ibin++){if(this._selected==ibin)this._context.fillStyle="Cyan";else this._context.fillStyle=this._bins[ibin].colour;var bar_top=(this._max-this._bins[ibin].count)/this._max*this._height;this._context.fillRect(this._axis_size+ibin*this._bin_width,bar_top,this._bin_width,this._height-bar_top);this._context.fillStyle="black";this._context.save();this._context.translate(this._axis_size+ibin*this._bin_width,this._context.canvas.height-10);this._context.rotate(Math.PI/10);this._context.fillText(this._bins[ibin].text,0,0,this._bin_width);this._context.restore()}this._context.fillStyle="black";this._context.fillText("0",0,this._height,this._axis_size);this._context.fillText(this._max,0,10,this._axis_size);this._context.restore()};this.update([])};var push_pull=push_pull||{};push_pull.PieChart=function(canvas,table,type){this._canvas=canvas;this._table=table;this._context=canvas[0].getContext("2d");this._center=[this._context.canvas.width/2,this._context.canvas.height/2];this._radius=this._context.canvas.width/2-40;this._selected=-1;this._type=type;this._data=[];this._colours=["red","orange","yellow","green","blue","indigo","violet"];this._canvas.on("mousemove",function(event){this.mouse_move(event)}.bind(this));this._canvas.on("mouseleave",function(){this._selected=-1;this.draw()}.bind(this));this._canvas.on("mouseup",function(event){this.mouse_click(event)}.bind(this));this.mouse_move=function(event){this.pick(event)};this.mouse_click=function(event){this.pick(event);if(this._selected>-1&&this._selected<this._colours.length)push_pull.change_selection(this._type,this._data[this._selected][2])};this.pick=function(event){var x=(event.pageX-this._canvas.offset().left)/this._canvas.width()*this._context.canvas.width;var y=(event.pageY-this._canvas.offset().top)/this._canvas.height()*this._context.canvas.height;var distance2=Math.pow(x-this._center[0],2)+Math.pow(y-this._center[1],2);if(distance2>Math.pow(this._radius,2)){this._selected=-1}else{var angle=Math.atan2(y-this._center[1],x-this._center[0]);if(angle<0)angle=2*Math.PI+angle;for(var idata=0;idata<this._data.length;idata++){if(angle>this._data[idata][0]&&angle<this._data[idata][1]){this._selected=idata;break}}}this.draw()};this.update=function(data){var total=0;for(var idata=0;idata<data.length;idata++)total+=data[idata][0];this._data=[];var start_angle=0;var image_loaded=function(){this.draw()}.bind(this);for(idata=0;idata<Math.min(this._colours.length,data.length);idata++){var image=push_pull.images[data[idata][2]];if(image===undefined){image=new Image;image.src=data[idata][2];push_pull.images[data[idata][2]]=image;image.onload=image_loaded}var end_angle=start_angle+data[idata][0]/total*2*Math.PI;this._data.push([start_angle,end_angle,data[idata][1],image,this._colours[idata]]);start_angle=end_angle}if(2*Math.PI-start_angle>0){this._data.push([start_angle,2*Math.PI,"others",null,"black"])}this._table.empty();var select_generator=function(type,name){return function(event){push_pull.change_selection(type,name)}};for(idata=0;idata<data.length;idata++){var row=$('<tr style="cursor:pointer;"><td>'+data[idata][0]+'</td><td><img src="'+data[idata][2]+'" width="20" height="20"></td><td>'+data[idata][1]+"</td></tr>");row.on("click",select_generator(this._type,data[idata][1]));this._table.append(row)}this.draw()};this.draw=function(){this._context.save();this._context.clearRect(0,0,this._context.canvas.width,this._context.canvas.height);for(var idata=0;idata<this._data.length;idata++){if(idata==this._selected)this._context.fillStyle="Cyan";else this._context.fillStyle=this._data[idata][4];this._context.beginPath();this._context.moveTo(this._center[0],this._center[1]);this._context.arc(this._center[0],this._center[1],this._radius,this._data[idata][0],this._data[idata][1]);this._context.lineTo(this._center[0],this._center[1]);this._context.closePath();this._context.fill();var image_angle=(this._data[idata][0]+this._data[idata][1])/2;var image=this._data[idata][3];var image_position=[this._center[0]+(this._radius+15)*Math.cos(image_angle)-10,this._center[1]+(this._radius+15)*Math.sin(image_angle)-10];if(image!==null)this._context.drawImage(image,0,0,image.width,image.height,image_position[0],image_position[1],20,20)}this._context.restore()};this.update([])};var push_pull=push_pull||{};push_pull.Graph=function(canvas,name){this._canvas=canvas;this._context=canvas[0].getContext("2d");this._data=[[0,0]];this._axis_size=30;this._height=this._context.canvas.height-this._axis_size;this._width=this._context.canvas.width-this._axis_size;this._log=false;this._x_name=name;this._canvas.on("mouseup",function(event){this._log=!this._log;this.draw()}.bind(this));this.update=function(data){this._data=data;if(data.length===0){this._x=[0,1];this._y=[0,1];this._data=[[0,0]]}else{this._data.sort(function(a,b){return a[1]-b[1]});this._y=[this._data[0][1],1.1*this._data[this._data.length-1][1]];this._data.sort(function(a,b){return a[0]-b[0]});this._x=[this._data[0][0],1.1*this._data[this._data.length-1][0]];if(this._y[0]<10)this._y[0]=0;if(this._x[0]<10)this._x[0]=0}this.draw()};this.draw=function(){this._context.save();this._context.clearRect(0,0,this._context.canvas.width,this._context.canvas.height);var xscale=this._width/(this._x[1]-this._x[0]);if(this._log)xscale=this._width/(Math.log(this._x[1]-this._x[0])/Math.LN10);var yscale=this._height/(this._y[1]-this._y[0]);var range=this._y[1]-this._y[0];for(var ipoint=0;ipoint<this._data.length;ipoint++){this._context.fillStyle="black";var x=this._data[ipoint][0]-this._x[0];if(this._log)x=Math.log(this._data[ipoint][0]-this._x[0])/Math.LN10;this._context.fillRect(this._axis_size+xscale*x,(this._y[1]-this._data[ipoint][1])*yscale-1,2,2)}this._context.strokeStyle="Blue";this._context.beginPath();this._context.moveTo(this._axis_size,0);this._context.lineTo(this._axis_size,this._height+1);this._context.lineTo(this._axis_size+this._width,this._height+1);this._context.stroke();this._context.closePath();this._context.fillStyle="black";this._context.fillText(this._y[0].toExponential(1),0,this._height,this._axis_size-1);this._context.fillText(this._y[1].toExponential(1),0,10,this._axis_size-1);this._context.fillText(this._x[0].toExponential(1),this._axis_size,this._height+10,this._axis_size-1);this._context.fillText(this._x[1].toExponential(1),this._width,this._height+10,this._axis_size-1);if(this._log)this._context.fillText("log "+this._x_name,this._width/2,this._height+20,60);else this._context.fillText(this._x_name,this._width/2,this._height+20,60);this._context.translate(10,this._height/2);this._context.rotate(-Math.PI/2);this._context.fillText("lifetime",0,0,this._axis_size-1);this._context.restore()};this.update([])};var push_pull=push_pull||{};push_pull.gh_objects=[];push_pull.images={};push_pull.MTypes=Object.freeze({PullRequest:1,Issue:2});push_pull.mode=push_pull.MTypes.PullRequest;push_pull.STypes=Object.freeze({None:0,Lifespan:1,Created:2,Assigned:3});push_pull.select=function(gh_object){return true};push_pull.lifespan_histogram=new push_pull.Histogram($("#lifespan"),$("#lifespan_list"));push_pull.created_pie=new push_pull.PieChart($("#created"),$("#created_list"),push_pull.STypes.Created);push_pull.assigned_pie=new push_pull.PieChart($("#assigned"),$("#assigned_list"),push_pull.STypes.Assigned);push_pull.lifetime_comments=new push_pull.Graph($("#lifetime_comments"),"comments");push_pull.lifetime_number=new push_pull.Graph($("#lifetime_number"),"# number");push_pull.lifetime_commits=new push_pull.Graph($("#lifetime_commits"),"commits");push_pull.lifetime_changes=new push_pull.Graph($("#lifetime_changes"),"changes");push_pull.change_selection=function(type,value,value2){if(type==push_pull.STypes.None){push_pull.select=function(gh_object){return true}}else if(type==push_pull.STypes.Lifespan){push_pull.select=function(gh_object){if(push_pull.lifespan(gh_object)<value2&&push_pull.lifespan(gh_object)>value)return true;return false}}else if(type==push_pull.STypes.Created){push_pull.select=function(gh_object){if(gh_object.user!==null&&gh_object.user.login==value)return true;return false}}else if(type==push_pull.STypes.Assigned&&push_pull.mode==push_pull.MTypes.PullRequest){push_pull.select=function(gh_object){if(gh_object.merged_by!==null&&gh_object.merged_by.login==value)return true;return false}}else if(type==push_pull.STypes.Assigned&&push_pull.mode==push_pull.MTypes.Issue){push_pull.select=function(gh_object){if(gh_object.assignee!==null&&gh_object.assignee.login==value)return true;return false}}push_pull.update()};push_pull.lifespan=function(gh_object){var created=new Date(gh_object.created_at);var closed=new Date(gh_object.closed_at);return closed-created};push_pull.update=function(){push_pull.update_lifespan();push_pull.update_created();push_pull.update_assigned();push_pull.update_plots()};push_pull.update_lifespan=function(){var lifespans=[];for(var iobject=0;iobject<push_pull.gh_objects.length;iobject++){if(push_pull.select(push_pull.gh_objects[iobject]))lifespans.push(push_pull.lifespan(push_pull.gh_objects[iobject]))}push_pull.lifespan_histogram.update(lifespans)};push_pull.update_created=function(){var contributors={};for(var iobject=0;iobject<push_pull.gh_objects.length;iobject++){if(push_pull.gh_objects[iobject].user===null||!push_pull.select(push_pull.gh_objects[iobject]))continue;var user=push_pull.gh_objects[iobject].user.login;if(contributors[user]===undefined)contributors[user]={avatar:push_pull.gh_objects[iobject].user.avatar_url,count:1};else contributors[user].count+=1}var sorted_contributors=push_pull.sort_contributors(contributors);push_pull.created_pie.update(sorted_contributors)};push_pull.update_assigned=function(){var contributors={};for(var iobject=0;iobject<push_pull.gh_objects.length;iobject++){if(!push_pull.select(push_pull.gh_objects[iobject]))continue;var user=null;var avatar=null;if(push_pull.mode==push_pull.MTypes.Issue&&push_pull.gh_objects[iobject].assignee!==null){user=push_pull.gh_objects[iobject].assignee.login;avatar=push_pull.gh_objects[iobject].assignee.avatar_url}else if(push_pull.mode==push_pull.MTypes.PullRequest&&push_pull.gh_objects[iobject].merged_by!==null){user=push_pull.gh_objects[iobject].merged_by.login;avatar=push_pull.gh_objects[iobject].merged_by.avatar_url}else continue;if(avatar===null)console.log(push_pull.gh_objects[iobject]);if(contributors[user]===undefined)contributors[user]={avatar:avatar,count:1};else contributors[user].count+=1}var sorted_contributors=push_pull.sort_contributors(contributors);push_pull.assigned_pie.update(sorted_contributors)};push_pull.sort_contributors=function(contributors){var sorted_contributors=[];for(var contributor in contributors){sorted_contributors.push([contributors[contributor].count,contributor,contributors[contributor].avatar])}sorted_contributors.sort(function(a,b){return b[0]-a[0]});return sorted_contributors};push_pull.update_plots=function(){var lifetime_comments=[];var lifetime_number=[];var lifetime_commits=[];var lifetime_changes=[];for(var iobject=0;iobject<push_pull.gh_objects.length;iobject++){if(!push_pull.select(push_pull.gh_objects[iobject]))continue;var lifespan=push_pull.lifespan(push_pull.gh_objects[iobject]);lifetime_comments.push([push_pull.gh_objects[iobject].comments,lifespan]);lifetime_number.push([push_pull.gh_objects[iobject].number,lifespan]);if(push_pull.gh_objects[iobject].commits)lifetime_commits.push([push_pull.gh_objects[iobject].commits,lifespan]);if(push_pull.gh_objects[iobject].additions&&push_pull.gh_objects[iobject].deletions)lifetime_changes.push([push_pull.gh_objects[iobject].additions+push_pull.gh_objects[iobject].deletions,lifespan])}push_pull.lifetime_comments.update(lifetime_comments);push_pull.lifetime_number.update(lifetime_number);push_pull.lifetime_commits.update(lifetime_commits);push_pull.lifetime_changes.update(lifetime_changes)};push_pull.process=function(json){for(var iobject=0;iobject<json.length;iobject++){$.getJSON(json[iobject].url,push_pull.process_object).error(push_pull.process_error)}push_pull.update()};push_pull.process_object=function(json){push_pull.gh_objects.push(json);if(push_pull.gh_objects.length<100)push_pull.update()};push_pull.process_error=function(error){$("#error").show();$.getJSON("https://api.github.com/rate_limit",function(result){$(".requests").text(result.resources.core.remaining)});$("#error_message").text(error.status+" "+error.statusText);push_pull.update()};push_pull.get_github_objects=function(type){push_pull.gh_objects=[];push_pull.change_selection(push_pull.STypes.None,null);var username=$("#username").val();var repository=$("#repository").val();get_json=function(username,repository,page){$.getJSON("https://api.github.com/repos/"+username+"/"+repository+"/"+type+"?state=closed&page="+page+"&per_page=100",function(json){push_pull.process(json);if(json.length>0)get_json(username,repository,page+1);else{$("#success").show();$.getJSON("https://api.github.com/rate_limit",function(result){$(".requests").text(result.resources.core.remaining)});setTimeout(function(){$("#success").fadeOut()},1500)}}).error(push_pull.process_error);push_pull.update()};get_json(username,repository,1)};$("#get_pulls").on("click",function(){push_pull.mode=push_pull.MTypes.PullRequest;push_pull.get_github_objects("pulls");$("#controls").fadeOut()});$("#get_issues").on("click",function(){push_pull.mode=push_pull.MTypes.Issue;push_pull.get_github_objects("issues");$("#controls").fadeOut()});$("#set_token").on("click",function(){$.ajaxSetup({headers:{Authorization:"token "+$("#token").val()}})});$("#reset_selection").on("click",function(){push_pull.change_selection(push_pull.STypes.None,null)});$("#show_controls").on("click",function(){$("#controls").fadeIn()});$("#hide_controls").on("click",function(){$("#controls").fadeOut()});$("#hide_error").on("click",function(){$("#error").fadeOut()});$("#help").on("click",function(){window.location.href="#help"});push_pull.resize=function(){$("#success").hide();$("#success").css({top:($(window).height()-$("#success").outerHeight())/2+"px",left:($(window).width()-$("#success").outerWidth())/2+"px"});$("#error").hide();$("#error").css({top:($(window).height()-$("#error").outerHeight())/2+"px",left:($(window).width()-$("#error").outerWidth())/2+"px"});$("#controls").css({top:($(window).height()-$("#controls").outerHeight())/10+"px",left:($(window).width()-$("#controls").outerWidth())/2+"px"})};$(window).resize(push_pull.resize());$(window).load(push_pull.resize());